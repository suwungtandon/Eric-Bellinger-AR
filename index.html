<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>8th Wall Web: Portal</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <script src="//cdn.8thwall.com/web/aframe/8frame-0.8.2.min.js"></script>
    <script src="//cdn.8thwall.com/web/xrextras/xrextras.js"></script>
    <script src="https://unpkg.com/aframe-animation-component@5.1.2/dist/aframe-animation-component.min.js"></script>
    <script src="https://unpkg.com/aframe-chromakey-material/dist/aframe-chromakey-material.min.js"></script>
    <!-- Key for live views -->
    <script async src="//apps.8thwall.com/xrweb?appKey=wyONtE6Bshkt55sLIUG5hfx92s31BZeEqJsGUSCmMuz6jRKoQMG5gcOeviyyVWP7sRa1Yb"></script>
    <!-- Key for Dev demo -->
    <!-- <script async src="//apps.8thwall.com/xrweb?appKey=zJQPuVaQKnl2p1EzjLHW1bxfHs7FTfLQFyhlRdb0f70rxT6gKOm8tSBYgHuHXVw0Bl7tLx"></script> -->

    <script>
      // Component click listener to play videosphere elements and animate elements:
      AFRAME.registerComponent('play-on-window-click', {
        init: function() {
          this.onClick = this.onClick.bind(this);
        },
        play: function() {
          window.addEventListener('click', this.onClick);
        },
        pause: function() {
          window.removeEventListener('click', this.onClick);
        },
        // Animate away the intro text and background
        onClick: function(evt) {
          let animDur = 500;
          let black = document.querySelector('#textBacking');
          let red = document.querySelector('#textBackingRed');
          let blue = document.querySelector('#textBackingBlue');
          red.setAttribute('animation__fly-left', {
            property: 'position',
            from: red.getAttribute('position'),
            to: '-1 0.2 0',
            dur: animDur,
            easing: 'easeInBack'
          });
          blue.setAttribute('animation__fly-right', {
            property: 'position',
            from: blue.getAttribute('position'),
            to: '1 -0.2 0',
            dur: animDur,
            easing: 'easeInBack'
          });
          black.setAttribute('animation__squish-all', {
            property: 'scale',
            from: black.getAttribute('scale'),
            to: '1 0.1 1',
            dur: animDur,
            easing: 'easeInExpo'
          });
          document.querySelector('a-videosphere').setAttribute('visible', true); // Show the video.
          window.setTimeout(function() {
            document.querySelector('#textBacking').setAttribute('visible', false); // Hide the intro after animation.
          }, animDur);
        }
      });

      // Go straight to link if no tap occurs in 15 seconds:
      var jumpAheadTimer;
      window.onload = function() {
      	jumpAheadTimer = window.setTimeout(function() {
      		window.location = 'https://ericbellinger.lnk.to/Therebirth2';
      	}, 15000);
      };

      //
      AFRAME.registerComponent('tap-place', {
        init: function() {
          const floor = document.querySelector('#floor');

          // Declare the function as a variable to juggle between add/remove event listeners:
          var runOnClick = function(event) {
            window.clearTimeout(jumpAheadTimer); // If clicked, clear this timer.
            var videoSphere = document.querySelector('#mainVid');
            // The raycaster gives a location of the touch in the scene:
            const touchPoint = event.detail.intersection.point;
            videoSphere.setAttribute('position', touchPoint); // Set the video where user tapped.
            videoSphere.object3D.position.y += 1.8; // Raise it up to float at bench height.
            let rot = document.querySelector('#camera').getAttribute('rotation');
            videoSphere.object3D.rotation.y = THREE.Math.degToRad(rot.y - 90); // Orient the video in the direction of the camera.
            animateVideo(); // Call the videoSphere element animations function.
            floor.removeEventListener('click', runOnClick, false); // Limit to one click per session.
          };
          // Add the listener for all of the above:
          floor.addEventListener('click', runOnClick, false);
        }
      });

      function animateVideo() {
        let vid = document.querySelector('#mainVid');
        let vidPos = vid.getAttribute('position');
        document.querySelector('#glitch-sphere').play();
        window.setTimeout(function() {
          document.querySelector('#glitch-visor').play();
        }, 1500);

        var dur0 = 600;
        var dur1 = 1000;
        var dur2 = 3500;
        var dur3 = 10000;

        vid.setAttribute('animation__visible-scale', {
          property: 'scale',
          from: vid.getAttribute('scale'),
          to: '-0.0007 0.0007 0.0007',
          delay: dur0,
          dur: dur1,
          easing: 'easeOutQuad'
        });

        vid.setAttribute('animation__pop-up', {
          property: 'position',
          from: vidPos,
          to: vidPos.x + ', 8.5, ' + vidPos.z,
          delay: dur0 + dur1 * 0.9,
          dur: dur2,
          elasticity: 575,
          easing: 'easeOutElastic'
        });

        vid.setAttribute('animation__full-scale', {
          property: 'scale',
          from: '-0.0007 0.0007 0.0007',
          to: '-0.2 0.2 0.2',
          delay: dur0 + (dur1 + dur2) * 0.9,
          dur: dur3,
          easing: 'easeInCubic'
        });

        var camPos = document.querySelector('#camera').getAttribute('position');
        vid.setAttribute('animation__to-camera', {
          property: 'position',
          from: vidPos.x + ', 8.5, ' + vidPos.z,
          to: camPos.x + ', ' + camPos.y + ', ' + camPos.z,
          delay: dur0 + (dur1 + dur2) * 0.9,
          dur: dur3,
          easing: 'easeOutCirc'
        });

        window.setTimeout(function() {
          var video = vid.components.material.material.map.image; // Drill down to video itself.
          console.log(this);
          if (!video) { return; } // Error handling.
          video.play();
          document.querySelector('#scene-audio').components.sound.playSound();
          // Navigate to Eric's webpage after 11 seconds (end of video + 1 second rest):
          window.setTimeout(function() {
            window.location = 'https://ericbellinger.lnk.to/Therebirth2';
          }, 13000);
        }, dur1 + dur2 + 2000);
      }
    </script>
  </head>

  <body>
    <!-- Load A-Frame with 8th Wall Web -->
    <a-scene
      xrweb
      tap-place
      xrextras-almost-there
      xrextras-loading
      xrextras-runtime-error>
      <!-- A-Frame asset manager -->
      <a-assets>
        <!-- MP4 video source for videosphere -->
        <video id="eb360" style="display:none" muted playsinline webkit-playsinline crossorigin="anonymous">
          <source type="video/mp4" src="eb360-hq-faster.mp4" width="4096px" height="2048px"/>
        </video>
        <audio id="eb-audio" src="eb-audio-slower.mp3"></audio>
        <video id="glitch-visor" src="glitch-visor.mp4" type="video/mp4" position="0 2 -3" rotation="90 120 0" autoplay playsinline muted crossorigin="anonymous"></video>
        <video id="glitch-sphere" src="glitch-sphere.mp4" type="video/mp4" position="0 2 -3" rotation="90 120 0" autoplay playsinline muted loop crossorigin="anonymous"></video>
        <!-- Credit to glitch overlays from freestockfootagearchive.com -->
      </a-assets>

      <a-camera
  			id="camera"
  			position="0 10 0"
  			raycaster="objects: .cantap"
  			cursor="fuse: false; rayOrigin: mouse;">
  			<!-- This plane serves as parent for the text and stylistic background planes: -->
  			<a-plane id="textBacking" width="3" height="0.5" position="-0.05 -1.5 -6" scale="1.3 1.3 1.3" color="black">
          <a-text id="tutorial" value="TAP THE ASTRONAUT" position="0 0.05 0.1" align="center" color="#ff1c9c" visible="true"></a-text>
          <a-text id="tutorial" value="TAP THE ASTRONAUT" position="0.01 0.04 0.09" align="center" color="#1fc2ee" visible="true"></a-text>
          <a-plane id="textBackingRed" width="3" height="0.5" position="-0.02 -0.02 -0.01" color="#ff1c9c"></a-plane>
          <a-plane id="textBackingBlue" width="3" height="0.5" position="0.02 0.02 -0.01" color="#1fc2ee"></a-plane>
      	</a-plane>
  		</a-camera>

      <!-- The videosphere itself. Default radius is 5000, so scale down -->
      <a-videosphere id="mainVid" play-on-window-click
        rotation="0 0 0"
        src="#eb360"
        scale="-0.000001 0.000001 0.000001"
        visible="false"
        material="side: double">
        <a-sphere material="shader: chromakey; src: #glitch-visor; color: 0 0 0; side: double" scale="5500 5500 5500"></a-sphere>
        <a-sphere material="shader: chromakey; src: #glitch-sphere; color: 0 0 0; side: double" scale="5600 5600 5600"></a-sphere>
      </a-videosphere>

      <a-entity id="scene-audio" sound="src: #eb-audio; positional: false; volume: 0.8"></a-entity>

      <!-- An entity for raycast detection on the groundplane -->
      <a-box
        id="floor"
        class="cantap"
      	geometry="primitive: box"
      	material="color: #0066bb; transparent: true; opacity: 0.0"
        position="0 0 0"
      	scale="1000 1 1000">
      </a-box>

    </a-scene>
  </body>
</html>
