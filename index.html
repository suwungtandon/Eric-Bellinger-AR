<!--
	Project by Tavius Koktavy with Jump into the Light for Eric Bellinger's ad campaign - github: https://github.com/kotavy/eric-bellinger-ar
	AR.js by @jerome_etienne - github: https://github.com/jeromeetienne/ar.js - info: https://medium.com/arjs/augmented-reality-in-10-lines-of-html-4e193ea9fdbf
-->

<head>
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

	<script src="https://aframe.io/releases/0.8.2/aframe.min.js"></script>

	<!-- Incorporates a customization of these modifications to reduce jitter: https://github.com/jeromeetienne/AR.js/pull/422/commits/7e247677f563e7858388b00eb46c226c92874bb5 -->
	<script src="aframe-ar.js"></script>
	<script>
		// Is explicitly asking for camera access necessary for some devices/browsers?
		var constraints = {
			audio: false,
			video: true
		};

		// When the app starts (user allows camera), hide the switch the text instructions:
		navigator.mediaDevices.getUserMedia(constraints).then(function(mediaStream) {
			document.querySelector('#tutorial').setAttribute('visible', true);
		});

		var noMarkerTimer;

		window.onload = function() {
			noMarkerTimer = window.setTimeout(function() {
				window.location = 'https://ericbellinger.lnk.to/Therebirth2';
			}, 15000);
		};

		// A compenent to live on the <a-scene> element, listening for 'markerFound' and 'makerLost' events.
		AFRAME.registerComponent('registerevents', {
			init: function() {
				var marker = document.querySelector('#marker');
				var foundVid = document.querySelector('#foundVid');
				var lostVid = document.querySelector('#lostVid');
				var startedPlaying = false;

				// When the scene sees a marker, swap and move elements:
				this.el.addEventListener('markerFound', function() {
					window.clearTimeout(noMarkerTimer);
					lostVid.setAttribute('visible', false); // Hide the placeholder video when the marker is recognized

					// Run the first time the marker is found:
					if (!startedPlaying) {
						startedPlaying = true;
						document.querySelector('#textBacking').setAttribute('visible', false); // Hide the text
						// Wait a half second before playing the video and audio
						window.setTimeout(function() {
							document.querySelector('video').play();
							document.querySelector('#foundAudio').components.sound.playSound();
						}, 1000);
						// Hide the marker guide after 2 seconds:
						window.setTimeout(function() {
							document.querySelector('#guideFrame').setAttribute('visible', false);
						}, 2000);
						// Navigate to Eric's webpage after 11 seconds (end of video + 1 second rest):
						window.setTimeout(function() {
							window.location = 'https://ericbellinger.lnk.to/Therebirth2';
						}, 11000);
					}
				});

				// When the scene loses a marker, sub in the placeholder video:
				this.el.addEventListener('markerLost', function() {
					foundVid.object3D.getWorldPosition(lostVid.object3D.position); // Copy foundVid's last position to lostVid
					marker.object3D.getWorldQuaternion(lostVid.object3D.quaternion); // Copy marker's last rotation to lostVid
					lostVid.object3D.rotateX(THREE.Math.degToRad(-90)); // Rotate lostVid to face screen
					lostVid.setAttribute('visible', true);
				});
			}
		});
	</script>
</head>

<body style="margin: 0px; overflow: hidden;">
	<a-scene registerevents embedded arjs="sourceType: webcam; canvasWidth: 1280; canvasHeight: 960; patternRatio: 0.93; detectionMode: color; debugUIEnabled: false;" keyboard-shortcuts="enterVR: false" vr-mode-ui="enabled: false">
		<a-assets>
			<img id="frame" src="frame.png" crossorigin="anonymous" />
			<video id="eb-vid" src="eb-vid.mp4" type="video/mp4" width="1080px" height="1080px" autoplay playsinline muted crossorigin="anonymous"></video>
			<audio id="eb-audio" src="eb-audio.mp3"></audio>
		</a-assets>

		<a-plane id="textBacking" width="3.5" height="0.5" position="-0.05 -2.4 -8" color="black">
			<a-text id="tutorial" value="SCAN AR MARKER" position="0 0.3 1" align="center" color="#ff1c9c" visible="false"></a-text>
		</a-plane>

		<a-image id="guideFrame" position="-0.05 -1.5 -8" rotation="0 0 0" width="0.8" height="0.8" material="side:double; src: #frame"></a-image>

		<a-marker id="marker" type="pattern" url="eb-patt.patt" emitevents="true" minconfidence="0.35">
			<a-video id="foundVid" src="#eb-vid" width="14" height="12" position="-0.5 0 -4" rotation="-90 0 0"></a-video>
			<a-entity id="foundAudio" sound="src: #eb-audio; positional: false; volume: 0.8"></a-entity>
		</a-marker>

		<a-video id="lostVid" src="#eb-vid" width="14" height="12"></a-video>

		<a-entity camera="fov: 100"></a-entity>
	</a-scene>
</body>
