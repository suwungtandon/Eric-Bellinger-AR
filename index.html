<!--
	Project by Tavius Koktavy with Jump into the Light for Eric Bellinger's ad campaign - github: https://github.com/kotavy/eric-bellinger-ar
	AR.js by @jerome_etienne - github: https://github.com/jeromeetienne/ar.js - info: https://medium.com/arjs/augmented-reality-in-10-lines-of-html-4e193ea9fdbf
-->

<head>
	<meta name="apple-mobile-web-app-capable" content="yes">

	<script src='https://aframe.io/releases/0.8.2/aframe.min.js'></script>
	<script src='aframe-ar.js'></script>
	<!-- Incorporating these modifications to reduce jitter: https://github.com/jeromeetienne/AR.js/pull/422/commits/7e247677f563e7858388b00eb46c226c92874bb5 -->
	<script>
		var constraints = {
			audio: false,
			video: true
		};

		navigator.mediaDevices.getUserMedia(constraints).then(function(mediaStream) {
			console.log("camera access granted");
			document.querySelector('#camAccess').setAttribute('visible', false);
			document.querySelector('#tutorial').setAttribute('visible', true);
		});

		var ended = false;

		AFRAME.registerComponent('registerevents', {
			init: function() {
				var marker = this.el;
				var plane = marker.firstElementChild;
				var marker = document.querySelector('#marker');
				var tempVid = document.querySelector('#tempVid');

				marker.addEventListener('markerFound', function() {
					if (!ended) {
						ended = true;
						window.setTimeout(function() {
							loadLink();
						}, 8000);
					}
					tempVid.setAttribute('visible', false);
					document.querySelector('a-plane').setAttribute('visible', false);
				});

				marker.addEventListener('markerLost', function() {
					let tempPosition = marker.getAttribute('position');
					let tempRotation = marker.getAttribute('rotation');
					tempVid.setAttribute('position', {
						x: tempPosition.x - 1,
						y: tempPosition.y + 5,
						z: tempPosition.z
					});
					//tempVid.setAttribute('rotation', {x: tempRotation.x - 90, y: tempRotation.y, z: tempRotation.z});
					tempVid.setAttribute('visible', true);
				});
			}
		});

		function loadLink() {
			// show link			//window.location = 'http://ericbellinger.com/';
			document.querySelector('a-plane').setAttribute('visible', false);
		}
	</script>
</head>

<body style='margin : 0px; overflow: hidden;'>
	<a-scene embedded arjs='debugUIEnabled: false; patternRatio: 0.93; detectionMode: color;' keyboard-shortcuts='enterVR: false' vr-mode-ui='enabled: false'>
		<a-assets timeout="30000">
			<img id="frame" src="frame.png">
			<video id="eb-vid" autoplay loop playsinline muted src="eb-vid.mp4" crossorigin="anonymous" />
		</a-assets>

		<a-plane width="3.5" height="0.5" position="-0.05 -1.5 -8" color="black">
			<a-text id="camAccess" value="Please allow camera access for AR" align="center"></a-text>
			<a-text id="tutorial" value="SCAN AR MARKER" position="0 0.2 1" align="center" color="#1ec2ee" visible="false"></a-text>
			<a-text id="link" value="SCAN AR MARKER" position="0 0.2 1" align="center" color="#1ec2ee" visible="false"></a-text>
			<a-plane id="arFrame" position='0 -0.9 0' rotation='0 0 0' width='1' height='1' material='side:double; src: #frame'></a-plane>
		</a-plane>

		<a-marker id='marker' registerevents emitevents='true' type='pattern' url='eb-patt-new.patt' minconfidence='0.5'>
			<a-video id='arVid' src='#eb-vid' width="15" height="14" position="-1 0 -5" rotation='-90 0 0'></a-video>
		</a-marker>

		<a-video id='tempVid' src='#eb-vid' width="15" height="14"></a-video>

		<a-entity camera></a-entity>
	</a-scene>

	<!-- <script>
		document.querySelector('#marker').setAttribute('visible', false);
	</script> -->
</body>